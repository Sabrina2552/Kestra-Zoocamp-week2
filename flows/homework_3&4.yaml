id: count_rows_smart
namespace: zoomcamp
description: |
  Smart CSV counter - checks which files exist before downloading
  This is generated by Claude. But I think it's better than what I wrote. :) Really Cool!
  
inputs:
  - id: taxi
    type: SELECT
    displayName: Select taxi type
    values: [yellow, green]
    defaults: green

  - id: year
    type: STRING
    displayName: Year
    defaults: "2020"

tasks:
  - id: check_available_files
    type: io.kestra.plugin.scripts.shell.Commands
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        #!/bin/bash
        
        echo "Checking available files for {{inputs.taxi}} taxi in {{inputs.year}}..."
        echo "================================================================="
        
        available_months=""
        
        # Check which files exist
        for month in 01 02 03 04 05 06 07 08 09 10 11 12; do
          file="{{inputs.taxi}}_tripdata_{{inputs.year}}-${month}.csv"
          url="https://github.com/DataTalksClub/nyc-tlc-data/releases/download/{{inputs.taxi}}/${file}.gz"
          
          # Use HEAD request to check if file exists (faster than downloading)
          if wget --spider -q "${url}" 2>/dev/null; then
            echo "âœ“ Month ${month}: ${file}.gz exists"
            available_months="${available_months}${month} "
          else
            echo "âœ— Month ${month}: ${file}.gz NOT FOUND"
          fi
        done
        
        echo ""
        echo "Available months: ${available_months}"
        echo "${available_months}" > available_months.txt
    outputFiles:
      - available_months.txt

  - id: download_and_count
    type: io.kestra.plugin.scripts.shell.Commands
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - |
        #!/bin/bash
        set -e
        
        # Read available months
        available_months="{{ read(outputs.check_available_files.outputFiles['available_months.txt']) }}"
        
        total_rows=0
        successful_months=0
        
        echo ""
        echo "================================================================="
        echo "Downloading and counting rows for {{inputs.taxi}} taxi in {{inputs.year}}"
        echo "================================================================="
        echo ""
        
        # Loop through only available months
        for month in ${available_months}; do
          file="{{inputs.taxi}}_tripdata_{{inputs.year}}-${month}.csv"
          url="https://github.com/DataTalksClub/nyc-tlc-data/releases/download/{{inputs.taxi}}/${file}.gz"
          
          echo "Processing month ${month}..."
          
          # Download and decompress
          wget -q -O "${file}.gz" "${url}"
          gunzip -f "${file}.gz"
          
          # Count total lines and subtract header
          total_lines=$(wc -l < "${file}")
          rows=$((total_lines - 1))
          
          echo "  â†’ ${rows} data rows"
          
          total_rows=$((total_rows + rows))
          successful_months=$((successful_months + 1))
          
          # Clean up
          rm -f "${file}"
        done
        
        echo ""
        echo "================================================================="
        echo "FINAL RESULT for {{inputs.taxi}} taxi in {{inputs.year}}"
        echo "================================================================="
        echo "Months processed: ${successful_months}/12"
        echo "Total data rows: ${total_rows}"
        echo "================================================================="
        
        # Save results
        echo "${total_rows}" > total_rows.txt
        echo "${successful_months}" > months_processed.txt
    outputFiles:
      - total_rows.txt
      - months_processed.txt

  - id: display_result
    type: io.kestra.plugin.core.log.Log
    message: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                        FINAL RESULT                            â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Taxi Type: {{inputs.taxi}}
      Year: {{inputs.year}}
      Months Found: {{ read(outputs.download_and_count.outputFiles['months_processed.txt']) }}/12
      
      ğŸ“Š TOTAL ROWS: {{ read(outputs.download_and_count.outputFiles['total_rows.txt']) }}
      
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
